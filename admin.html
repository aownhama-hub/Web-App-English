<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Admin V2 - Smart Editor</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; height: 100vh; margin: 0; display: flex; background: #f1f5f9; overflow: hidden; }
        
        /* SIDEBAR H∆Ø·ªöNG D·∫™N */
        .sidebar { width: 280px; background: #1e293b; color: white; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; font-size: 0.9rem; }
        .sidebar h2 { color: #60a5fa; margin-top: 0; }
        .syntax-box { background: #334155; padding: 10px; border-radius: 6px; font-family: monospace; font-size: 0.8rem; border: 1px solid #475569; color: #e2e8f0; }
        .syntax-title { font-weight: bold; color: #fbbf24; margin-bottom: 5px; display: block; }
        
        /* KHUNG CH√çNH */
        .main { flex: 1; display: flex; flex-direction: column; padding: 15px; gap: 15px; }
        
        /* TR√åNH SO·∫†N TH·∫¢O */
        .editor-area { flex: 1; display: flex; gap: 15px; min-height: 0; }
        .input-col { flex: 1; display: flex; flex-direction: column; }
        .preview-col { flex: 1; background: white; border-radius: 8px; padding: 15px; overflow-y: auto; border: 1px solid #cbd5e1; }
        
        textarea { flex: 1; padding: 15px; border-radius: 8px; border: 1px solid #cbd5e1; font-family: 'Consolas', monospace; resize: none; line-height: 1.5; font-size: 14px; }
        
        /* THANH C√îNG C·ª§ */
        .toolbar { display: flex; justify-content: space-between; align-items: center; background: white; padding: 10px 20px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        button { padding: 10px 20px; border-radius: 6px; border: none; font-weight: bold; cursor: pointer; }
        .btn-save { background: #2563eb; color: white; }
        .btn-save:hover { background: #1d4ed8; }
        .btn-save:disabled { background: #94a3b8; cursor: not-allowed; }

        /* PREVIEW CARDS */
        .card { background: #f8fafc; border: 1px solid #e2e8f0; padding: 10px; border-radius: 6px; margin-bottom: 10px; position: relative; border-left: 4px solid #94a3b8; }
        .card.type-multi { border-left-color: #3b82f6; } /* Xanh d∆∞∆°ng */
        .card.type-image { border-left-color: #ec4899; } /* H·ªìng */
        .card.type-listening { border-left-color: #8b5cf6; } /* T√≠m */
        .card.type-matching { border-left-color: #f59e0b; } /* Cam */
        
        .card h4 { margin: 0 0 5px 0; font-size: 0.95rem; color: #334155; }
        .badge { display: inline-block; font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; color: white; margin-right: 5px; vertical-align: middle; }
        .tags { margin-bottom: 5px; }
        .tag-pill { background: #e2e8f0; color: #475569; font-size: 0.7rem; padding: 1px 6px; border-radius: 10px; margin-right: 3px; }
        
        .card ul { padding-left: 20px; margin: 5px 0; font-size: 0.9rem; }
        .correct { color: #166534; font-weight: bold; }
        .media-link { display: block; font-size: 0.8rem; color: #0284c7; text-decoration: none; margin-bottom: 5px; }

        /* SERVER LIST (DANH S√ÅCH B√äN D∆Ø·ªöI) */
        .server-list { height: 200px; background: white; padding: 15px; border-radius: 8px; border: 1px solid #cbd5e1; overflow-y: auto; }
        .list-item { display: flex; justify-content: space-between; padding: 8px; border-bottom: 1px solid #eee; font-size: 0.9rem; }
        .list-item:hover { background: #f1f5f9; }
        .btn-mini { padding: 4px 10px; font-size: 0.75rem; margin-left: 5px; }
        .editing-mode { border: 2px solid #f59e0b; background: #fffbeb; }
    </style>
</head>
<body>

<div class="sidebar">
    <h2>üõ† C√∫ ph√°p nh·∫≠p</h2>
    
    <div class="syntax-box">
        <span class="syntax-title">1. G√°n Tag chung:</span>
        [TAGS: Unit 1, Grammar]<br>
        (√Åp d·ª•ng cho c√°c c√¢u b√™n d∆∞·ªõi)
    </div>

    <div class="syntax-box">
        <span class="syntax-title">2. Tr·∫Øc nghi·ªám (M·∫∑c ƒë·ªãnh):</span>
        C√¢u h·ªèi l√† g√¨?
        ƒê√°p √°n A
        *ƒê√°p √°n ƒë√∫ng
        ƒê√°p √°n C
    </div>

    <div class="syntax-box">
        <span class="syntax-title">3. H√¨nh ·∫£nh / Nghe:</span>
        [TYPE: IMAGE] (ho·∫∑c LISTENING)<br>
        [IMG: link_anh.jpg]<br>
        C√¢u h·ªèi?<br>
        *ƒê√∫ng<br>
        Sai
    </div>

    <div class="syntax-box">
        <span class="syntax-title">4. N·ªëi t·ª´:</span>
        [TYPE: MATCHING]<br>
        N·ªëi t·ª´ sau:<br>
        Hello -> Xin ch√†o<br>
        Cat -> Con m√®o
    </div>
    
    <div style="margin-top:auto; font-size:0.8rem; color:#94a3b8">
        V2.0 - Firebase Integrated
    </div>
</div>

<div class="main">
    <!-- Toolbar -->
    <div class="toolbar">
        <div>
            <strong>Tr·∫°ng th√°i: </strong> 
            <span id="status">S·∫µn s√†ng</span>
        </div>
        <div>
            <input type="hidden" id="edit-id"> <!-- L∆∞u ID n·∫øu ƒëang s·ª≠a -->
            <button class="btn-save" id="btn-submit" onclick="pushToFirebase()">‚òÅÔ∏è ƒê·∫©y l√™n Firebase</button>
            <button style="background:#64748b; color:white; display:none" id="btn-cancel" onclick="cancelEdit()">Hu·ª∑ s·ª≠a</button>
        </div>
    </div>

    <!-- Editor -->
    <div class="editor-area">
        <div class="input-col">
            <textarea id="input" placeholder="Nh·∫≠p b√†i t·∫≠p t·∫°i ƒë√¢y theo c√∫ ph√°p..."></textarea>
        </div>
        <div class="preview-col" id="preview">
            <div style="color:#94a3b8; text-align:center; margin-top:50px">Xem tr∆∞·ªõc s·∫Ω hi·ªán ·ªü ƒë√¢y</div>
        </div>
    </div>

    <!-- Server List -->
    <div class="server-list">
        <strong>üìö B√†i t·∫≠p hi·ªán c√≥ tr√™n Server (<span id="total-count">0</span>)</strong>
        <div id="db-list">Loading...</div>
    </div>
</div>

<!-- FIREBASE SDK V12.8.0 -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
    import { getFirestore, collection, addDoc, doc, updateDoc, deleteDoc, onSnapshot, orderBy, query, getDoc } 
    from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

    // --- CONFIG FIREBASE C·ª¶A B·∫†N ---
    const firebaseConfig = {
        apiKey: "AIzaSyDnQI6YmFYn10BYO1N_QckXfa9qodZaVK8",
        authDomain: "english-quiz-app-cca0c.firebaseapp.com",
        projectId: "english-quiz-app-cca0c",
        storageBucket: "english-quiz-app-cca0c.firebasestorage.app",
        messagingSenderId: "17129090734",
        appId: "1:17129090734:web:1103e4ad4a655d4566c73f",
        measurementId: "G-MXH5BKKTZ4"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const qCol = collection(db, "questions");

    // BI·∫æN TO√ÄN C·ª§C
    let parsedObjects = []; // Ch·ª©a d·ªØ li·ªáu sau khi d·ªãch

    // 1. L·∫ÆNG NGHE D·ªÆ LI·ªÜU T·ª™ SERVER (REALTIME)
    onSnapshot(query(qCol, orderBy("createdAt", "desc")), (snapshot) => {
        const listEl = document.getElementById('db-list');
        document.getElementById('total-count').innerText = snapshot.size;
        listEl.innerHTML = '';

        snapshot.forEach(docSnap => {
            const data = docSnap.data();
            const id = docSnap.id;
            const typeLabel = getTypeLabel(data.type);
            
            const div = document.createElement('div');
            div.className = 'list-item';
            div.id = `row-${id}`;
            div.innerHTML = `
                <div style="flex:1">
                    <span style="font-weight:bold; color:${typeLabel.color}">[${typeLabel.text}]</span> 
                    ${data.question.substring(0, 60)}...
                    <br>
                    <small style="color:#64748b">Tags: ${data.tags ? data.tags.join(', ') : 'None'}</small>
                </div>
                <div>
                    <button class="btn-mini" style="background:#fbbf24; border:1px solid #d97706" id="edit-${id}">S·ª≠a</button>
                    <button class="btn-mini" style="background:#fee2e2; border:1px solid #ef4444; color:#b91c1c" id="del-${id}">Xo√°</button>
                </div>
            `;
            listEl.appendChild(div);

            document.getElementById(`del-${id}`).onclick = () => deleteItem(id);
            document.getElementById(`edit-${id}`).onclick = () => loadForEdit(id, data);
        });
    });

    // 2. B·ªò D·ªäCH (PARSER): TEXT -> JSON
    document.getElementById('input').addEventListener('input', parseText);

    function parseText() {
        const raw = document.getElementById('input').value;
        const blocks = raw.split(/\n\s*\n/).filter(b => b.trim());
        const previewEl = document.getElementById('preview');
        
        parsedObjects = [];
        previewEl.innerHTML = '';
        
        let currentTags = []; // L∆∞u tag d√πng chung

        blocks.forEach((block, idx) => {
            const lines = block.split('\n').map(l => l.trim()).filter(l => l);
            if(lines.length === 0) return;

            // KI·ªÇM TRA L·ªÜNH G√ÅN TAG CHUNG: [TAGS: A, B]
            if (lines[0].toUpperCase().startsWith('[TAGS:')) {
                const tagStr = lines[0].substring(6, lines[0].length - 1); // L·∫•y n·ªôi dung trong []
                currentTags = tagStr.split(',').map(t => t.trim());
                return; // ƒê√¢y l√† block c·∫•u h√¨nh, kh√¥ng ph·∫£i c√¢u h·ªèi
            }

            // X·ª¨ L√ù C√ÇU H·ªéI
            let type = 'multi'; // M·∫∑c ƒë·ªãnh
            let media = '';
            let question = '';
            let options = [];
            let correct = -1;
            let pairs = []; // Cho b√†i matching
            let explain = '';

            // Qu√©t c√°c d√≤ng metadata [TYPE], [IMG], [AUDIO]
            let contentLines = [];
            lines.forEach(line => {
                if (line.toUpperCase().startsWith('[TYPE:')) {
                    const t = line.split(':')[1].trim().replace(']', '').toLowerCase();
                    if (['image', 'listening', 'matching'].includes(t)) type = t;
                } else if (line.toUpperCase().startsWith('[IMG:') || line.toUpperCase().startsWith('[AUDIO:')) {
                    media = line.split(/:(.+)/)[1].trim().replace(']', ''); // L·∫•y sau d·∫•u : ƒë·∫ßu ti√™n
                } else if (line.startsWith('>')) {
                    explain = line.substring(1).trim();
                } else {
                    contentLines.push(line);
                }
            });

            if(contentLines.length === 0) return;
            question = contentLines[0]; // D√≤ng ƒë·∫ßu ti√™n l√† c√¢u h·ªèi

            // X·ª≠ l√Ω n·ªôi dung theo t·ª´ng lo·∫°i
            if (type === 'matching') {
                // B√†i n·ªëi: T√¨m d·∫•u ->
                for(let i=1; i<contentLines.length; i++) {
                    const parts = contentLines[i].split('->');
                    if(parts.length === 2) {
                        pairs.push({ left: parts[0].trim(), right: parts[1].trim() });
                    }
                }
            } else {
                // B√†i tr·∫Øc nghi·ªám / ·∫£nh / nghe
                let optIdx = 0;
                for(let i=1; i<contentLines.length; i++) {
                    let txt = contentLines[i];
                    if(txt.startsWith('*')) { correct = optIdx; txt = txt.substring(1).trim(); }
                    options.push(txt);
                    optIdx++;
                }
            }

            // ƒê√≥ng g√≥i Object
            const obj = { type, question, media, options, correctIndex: correct, matchPairs: pairs, explanation: explain, tags: currentTags };
            parsedObjects.push(obj);

            // RENDER PREVIEW
            renderCard(obj, idx, previewEl);
        });

        // Update n√∫t b·∫•m
        const btn = document.getElementById('btn-submit');
        const isEdit = document.getElementById('edit-id').value !== "";
        const isValid = parsedObjects.length > 0;
        
        btn.disabled = !isValid;
        btn.innerText = isEdit ? "L∆∞u thay ƒë·ªïi" : `‚òÅÔ∏è ƒê·∫©y ${parsedObjects.length} c√¢u l√™n Server`;
        
        // C·∫£nh b√°o n·∫øu ƒëang s·ª≠a m√† nh·∫≠p nhi·ªÅu block
        if(isEdit && parsedObjects.length > 1) {
            document.getElementById('status').innerText = "‚ö†Ô∏è Ch·∫ø ƒë·ªô s·ª≠a ch·ªâ h·ªó tr·ª£ 1 c√¢u h·ªèi!";
            document.getElementById('status').style.color = "red";
            btn.disabled = true;
        } else {
            document.getElementById('status').innerText = "S·∫µn s√†ng";
            document.getElementById('status').style.color = "black";
        }
    }

    function renderCard(data, idx, container) {
        let contentHtml = '';
        let badgeColor = '#3b82f6';
        
        if (data.type === 'matching') {
            badgeColor = '#f59e0b';
            contentHtml = data.matchPairs.map(p => `<li>${p.left} ‚û°Ô∏è ${p.right}</li>`).join('');
        } else {
            if(data.type === 'image') badgeColor = '#ec4899';
            if(data.type === 'listening') badgeColor = '#8b5cf6';
            
            contentHtml = data.options.map((o, i) => 
                `<li class="${i===data.correctIndex ? 'correct' : ''}">${i===data.correctIndex ? '‚úÖ ' : ''}${o}</li>`
            ).join('');
        }

        const tagsHtml = data.tags.map(t => `<span class="tag-pill">${t}</span>`).join('');
        const mediaHtml = data.media ? `<a href="${data.media}" target="_blank" class="media-link">üîó File ƒë√≠nh k√®m</a>` : '';

        container.innerHTML += `
            <div class="card type-${data.type}">
                <div class="tags">${tagsHtml}</div>
                <h4>
                    <span class="badge" style="background:${badgeColor}">${data.type.toUpperCase()}</span>
                    ${idx+1}. ${data.question}
                </h4>
                ${mediaHtml}
                <ul>${contentHtml}</ul>
            </div>
        `;
    }

    // 3. CH·ª®C NƒÇNG: ƒê·∫®Y L√äN FIREBASE
    window.pushToFirebase = async function() {
        const btn = document.getElementById('btn-submit');
        const editId = document.getElementById('edit-id').value;

        if (!confirm("X√°c nh·∫≠n l∆∞u d·ªØ li·ªáu?")) return;

        btn.disabled = true;
        btn.innerText = "‚è≥ ƒêang x·ª≠ l√Ω...";

        try {
            if (editId) {
                // UPDATE (Ch·ªâ s·ª≠a 1 c√¢u)
                if(parsedObjects.length !== 1) throw new Error("Khi s·ª≠a ch·ªâ ƒë∆∞·ª£c ƒë·ªÉ l·∫°i 1 c√¢u h·ªèi trong khung.");
                
                const data = parsedObjects[0];
                data.createdAt = Date.now(); // Update time
                
                await updateDoc(doc(db, "questions", editId), data);
                alert("‚úÖ ƒê√£ c·∫≠p nh·∫≠t xong!");
                cancelEdit();
            } else {
                // CREATE (T·∫°o nhi·ªÅu c√¢u)
                const promises = parsedObjects.map(data => {
                    data.createdAt = Date.now();
                    return addDoc(qCol, data);
                });
                await Promise.all(promises);
                alert(`‚úÖ ƒê√£ th√™m ${parsedObjects.length} c√¢u h·ªèi m·ªõi!`);
                document.getElementById('input').value = "";
                parseText(); // Clear preview
            }
        } catch (e) {
            alert("L·ªói: " + e.message);
        } finally {
            btn.disabled = false;
        }
    }

    // 4. CH·ª®C NƒÇNG: XO√Å
    window.deleteItem = async function(id) {
        if(!confirm("Xo√° c√¢u h·ªèi n√†y?")) return;
        try {
            await deleteDoc(doc(db, "questions", id));
        } catch(e) {
            alert("L·ªói xo√°: " + e.message);
        }
    }

    // 5. CH·ª®C NƒÇNG: S·ª¨A (D·ªäCH NG∆Ø·ª¢C JSON -> TEXT)
    window.loadForEdit = function(id, data) {
        // Highlight d√≤ng ƒëang s·ª≠a
        document.querySelectorAll('.list-item').forEach(el => el.classList.remove('editing-mode'));
        document.getElementById(`row-${id}`).classList.add('editing-mode');

        document.getElementById('edit-id').value = id;
        document.getElementById('btn-cancel').style.display = 'inline-block';
        
        // --- LOGIC REVERSE PARSER (QUAN TR·ªåNG) ---
        let text = "";
        
        // 1. Tags
        if(data.tags && data.tags.length > 0) {
            text += `[TAGS: ${data.tags.join(', ')}]\n\n`;
        }

        // 2. Type & Media
        if(data.type !== 'multi') text += `[TYPE: ${data.type.toUpperCase()}]\n`;
        if(data.media) {
            const tag = data.type === 'listening' ? 'AUDIO' : 'IMG';
            text += `[${tag}: ${data.media}]\n`;
        }

        // 3. Question
        text += `${data.question}\n`;

        // 4. Options / Pairs
        if(data.type === 'matching') {
            data.matchPairs.forEach(p => {
                text += `${p.left} -> ${p.right}\n`;
            });
        } else {
            data.options.forEach((opt, idx) => {
                const prefix = idx === data.correctIndex ? '*' : '';
                text += `${prefix}${opt}\n`;
            });
        }

        // 5. Explain
        if(data.explanation) text += `> ${data.explanation}`;

        // ƒê∆∞a v√†o khung
        document.getElementById('input').value = text;
        parseText(); // Trigger l·∫°i preview
        document.getElementById('input').focus();
    }

    window.cancelEdit = function() {
        document.getElementById('edit-id').value = "";
        document.getElementById('btn-cancel').style.display = 'none';
        document.getElementById('input').value = "";
        document.querySelectorAll('.list-item').forEach(el => el.classList.remove('editing-mode'));
        parseText();
    }

    function getTypeLabel(type) {
        switch(type) {
            case 'listening': return {text: 'Nghe', color: '#8b5cf6'};
            case 'image': return {text: 'H√¨nh', color: '#ec4899'};
            case 'matching': return {text: 'N·ªëi', color: '#f59e0b'};
            default: return {text: 'Tr·∫Øc nghi·ªám', color: '#3b82f6'};
        }
    }

</script>

</body>
</html>
