<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Qu·∫£n tr·ªã B√†i t·∫≠p (Firebase Real)</title>
    <style>
        body { font-family: sans-serif; display: flex; height: 100vh; margin: 0; background: #f8fafc; overflow: hidden; }
        
        /* C·ªòT TR√ÅI: FORM NH·∫¨P LI·ªÜU */
        .editor-panel { width: 40%; padding: 20px; border-right: 1px solid #ddd; display: flex; flex-direction: column; background: white; }
        h2 { margin-top: 0; color: #1e293b; }
        
        .form-group { margin-bottom: 15px; }
        label { display: block; font-weight: bold; margin-bottom: 5px; font-size: 0.9rem; }
        input, textarea, select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; }
        textarea { height: 80px; resize: vertical; font-family: monospace; }
        
        /* Options inputs */
        .opt-row { display: flex; align-items: center; gap: 5px; margin-bottom: 5px; }
        .opt-row input[type="radio"] { width: 20px; cursor: pointer; }
        
        /* Buttons */
        .btn-action { width: 100%; padding: 12px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; margin-top: 10px; transition: 0.2s; }
        .btn-save { background: #2563eb; color: white; }
        .btn-save:hover { background: #1d4ed8; }
        .btn-cancel { background: #64748b; color: white; display: none; margin-top: 5px; } 

        /* C·ªòT PH·∫¢I: DANH S√ÅCH */
        .list-panel { flex: 1; padding: 20px; overflow-y: auto; background: #f1f5f9; }
        .q-card { background: white; padding: 15px; border-radius: 8px; margin-bottom: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); position: relative; border-left: 4px solid #2563eb; }
        
        .q-card h4 { margin: 0 0 10px 0; font-size: 1rem; color: #334155; }
        .q-tag { font-size: 0.75rem; background: #e0f2fe; color: #0284c7; padding: 2px 6px; border-radius: 4px; font-weight: bold; }
        
        .card-actions { margin-top: 10px; display: flex; gap: 10px; justify-content: flex-end; border-top: 1px solid #eee; padding-top: 10px; }
        .btn-mini { padding: 5px 12px; border-radius: 4px; border: none; cursor: pointer; font-size: 0.85rem; }
        .btn-edit { background: #fbbf24; color: #78350f; }
        .btn-del { background: #fee2e2; color: #991b1b; }
        
        .editing { border-color: #fbbf24; background: #fffbeb; }
    </style>
</head>
<body>

<div class="editor-panel">
    <h2 id="form-title">üìù T·∫°o b√†i t·∫≠p m·ªõi</h2>
    
    <div class="form-group">
        <label>Tag / Ch·ªß ƒë·ªÅ:</label>
        <input type="text" id="inp-tag" placeholder="V√≠ d·ª•: Unit 1, Grammar...">
    </div>

    <div class="form-group">
        <label>C√¢u h·ªèi:</label>
        <textarea id="inp-question" placeholder="Nh·∫≠p n·ªôi dung c√¢u h·ªèi..."></textarea>
    </div>

    <div class="form-group">
        <label>ƒê√°p √°n (Ch·ªçn radio b√™n c·∫°nh ƒë√°p √°n ƒë√∫ng):</label>
        <div id="options-container">
            <div class="opt-row"><input type="radio" name="correct" value="0" checked><input type="text" id="opt-0" placeholder="ƒê√°p √°n A"></div>
            <div class="opt-row"><input type="radio" name="correct" value="1"><input type="text" id="opt-1" placeholder="ƒê√°p √°n B"></div>
            <div class="opt-row"><input type="radio" name="correct" value="2"><input type="text" id="opt-2" placeholder="ƒê√°p √°n C"></div>
            <div class="opt-row"><input type="radio" name="correct" value="3"><input type="text" id="opt-3" placeholder="ƒê√°p √°n D"></div>
        </div>
    </div>

    <div class="form-group">
        <label>Gi·∫£i th√≠ch (Tu·ª≥ ch·ªçn):</label>
        <textarea id="inp-explain" placeholder="Gi·∫£i th√≠ch v√¨ sao ƒë√∫ng..." style="height: 50px;"></textarea>
    </div>

    <input type="hidden" id="edit-id" value="">

    <button class="btn-action btn-save" onclick="saveData()" id="btn-submit">üíæ L∆∞u b√†i t·∫≠p</button>
    <button class="btn-action btn-cancel" onclick="resetForm()" id="btn-cancel">Hu·ª∑ s·ª≠a</button>
</div>

<div class="list-panel">
    <h3>Danh s√°ch c√¢u h·ªèi tr√™n Server (<span id="count">0</span>)</h3>
    <div id="list-container">ƒêang k·∫øt n·ªëi Firebase...</div>
</div>

<script type="module">
    // Import c√°c h√†m c·∫ßn thi·∫øt t·ª´ Firebase SDK v12.8.0
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-analytics.js";
    // QUAN TR·ªåNG: Th√™m Firestore ƒë·ªÉ l∆∞u d·ªØ li·ªáu
    import { getFirestore, collection, addDoc, doc, updateDoc, deleteDoc, onSnapshot, orderBy, query } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

    // C·∫•u h√¨nh Firebase c·ªßa b·∫°n
    const firebaseConfig = {
        apiKey: "AIzaSyDnQI6YmFYn10BYO1N_QckXfa9qodZaVK8",
        authDomain: "english-quiz-app-cca0c.firebaseapp.com",
        projectId: "english-quiz-app-cca0c",
        storageBucket: "english-quiz-app-cca0c.firebasestorage.app",
        messagingSenderId: "17129090734",
        appId: "1:17129090734:web:1103e4ad4a655d4566c73f",
        measurementId: "G-MXH5BKKTZ4"
    };

    // Kh·ªüi t·∫°o Firebase
    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app); // Gi·ªØ l·∫°i Analytics theo m√£ c·ªßa b·∫°n
    const db = getFirestore(app);      // Kh·ªüi t·∫°o Database
    const qCol = collection(db, "questions");

    // --- LOGIC ·ª®NG D·ª§NG (GI·ªÆ NGUY√äN NH∆Ø C≈®) ---

    // 1. L·∫ÆNG NGHE D·ªÆ LI·ªÜU TH·ª∞C
    onSnapshot(query(qCol, orderBy("createdAt", "desc")), (snapshot) => {
        const listDiv = document.getElementById('list-container');
        document.getElementById('count').innerText = snapshot.size;
        listDiv.innerHTML = "";

        snapshot.forEach(docSnap => {
            const data = docSnap.data();
            const id = docSnap.id;
            
            const div = document.createElement('div');
            div.className = `q-card ${id === getCurrentEditId() ? 'editing' : ''}`;
            div.innerHTML = `
                <span class="q-tag">${data.tag}</span>
                <h4>${data.question}</h4>
                <div style="font-size: 0.9rem; color: #64748b;">
                    ƒê√∫ng: <b>${data.options[data.correctIndex]}</b>
                </div>
                <div class="card-actions">
                    <button class="btn-mini btn-edit" id="btn-edit-${id}">‚úèÔ∏è S·ª≠a</button>
                    <button class="btn-mini btn-del" id="btn-del-${id}">üóë Xo√°</button>
                </div>
            `;
            listDiv.appendChild(div);

            document.getElementById(`btn-del-${id}`).onclick = () => deleteQuestion(id);
            document.getElementById(`btn-edit-${id}`).onclick = () => loadToForm(id, data);
        });
    });

    // C√°c h√†m x·ª≠ l√Ω d·ªØ li·ªáu (G√°n v√†o window ƒë·ªÉ HTML g·ªçi ƒë∆∞·ª£c)
    window.saveData = async function() {
        const btn = document.getElementById('btn-submit');
        const question = document.getElementById('inp-question').value.trim();
        const tag = document.getElementById('inp-tag').value.trim() || "General";
        const explain = document.getElementById('inp-explain').value.trim();
        const editId = document.getElementById('edit-id').value;

        const options = [];
        for(let i=0; i<4; i++) options.push(document.getElementById(`opt-${i}`).value.trim());
        const correctIndex = parseInt(document.querySelector('input[name="correct"]:checked').value);

        if(!question || options.some(o => !o)) return alert("Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß c√¢u h·ªèi v√† 4 ƒë√°p √°n!");

        btn.disabled = true;
        btn.innerText = "ƒêang x·ª≠ l√Ω...";

        try {
            const dataPayload = {
                question, options, correctIndex, explanation: explain, tag,
                createdAt: Date.now()
            };

            if (editId) {
                await updateDoc(doc(db, "questions", editId), dataPayload);
                alert("‚úÖ ƒê√£ c·∫≠p nh·∫≠t th√†nh c√¥ng!");
                resetForm();
            } else {
                await addDoc(qCol, dataPayload);
                clearInputsOnly();
            }

        } catch (e) {
            alert("L·ªói: " + e.message);
            console.error(e);
        } finally {
            btn.disabled = false;
            btn.innerText = editId ? "L∆∞u thay ƒë·ªïi" : "üíæ L∆∞u b√†i t·∫≠p";
        }
    }

    window.deleteQuestion = async function(id) {
        if(!confirm("B·∫°n ch·∫Øc ch·∫Øn mu·ªën xo√° c√¢u n√†y?")) return;
        try {
            await deleteDoc(doc(db, "questions", id));
        } catch (e) {
            alert("L·ªói xo√°: " + e.message);
        }
    }

    window.loadToForm = function(id, data) {
        document.getElementById('edit-id').value = id;
        document.getElementById('form-title').innerText = "‚úèÔ∏è ƒêang s·ª≠a b√†i t·∫≠p";
        document.getElementById('btn-submit').innerText = "L∆∞u thay ƒë·ªïi";
        document.getElementById('btn-submit').style.background = "#fbbf24";
        document.getElementById('btn-submit').style.color = "#78350f";
        document.getElementById('btn-cancel').style.display = "block";

        document.getElementById('inp-tag').value = data.tag;
        document.getElementById('inp-question').value = data.question;
        document.getElementById('inp-explain').value = data.explanation || "";
        for(let i=0; i<4; i++) document.getElementById(`opt-${i}`).value = data.options[i];
        document.getElementsByName('correct')[data.correctIndex].checked = true;
    }

    window.resetForm = function() {
        document.getElementById('edit-id').value = "";
        document.getElementById('form-title').innerText = "üìù T·∫°o b√†i t·∫≠p m·ªõi";
        document.getElementById('btn-submit').innerText = "üíæ L∆∞u b√†i t·∫≠p";
        document.getElementById('btn-submit').style.background = "#2563eb";
        document.getElementById('btn-submit').style.color = "white";
        document.getElementById('btn-cancel').style.display = "none";
        clearInputsOnly();
    }

    function clearInputsOnly() {
        document.getElementById('inp-question').value = "";
        document.getElementById('inp-explain').value = "";
        for(let i=0; i<4; i++) document.getElementById(`opt-${i}`).value = "";
        document.getElementById('opt-0').focus();
    }

    function getCurrentEditId() {
        return document.getElementById('edit-id').value;
    }
</script>

</body>
</html>
